name: Build and Deploy .NET App to Azure VM

on:
  push:
    branches: [ main ]  # Adjust if using a different branch
  workflow_dispatch:    # Allows manual trigger

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      RESOURCE_GROUP: tries
      VM_NAME: servicebustry2

    steps:
    - name: ðŸ§¾ Checkout code
      uses: actions/checkout@v3

    - name: ðŸ› ï¸ Setup .NET SDK
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: ðŸ“¦ Restore dependencies
      run: dotnet restore

    - name: ðŸ—ï¸ Build app
      run: dotnet build --configuration Release --no-restore

    - name: ðŸš€ Publish app
      run: dotnet publish --configuration Release --output ./publish

    - name: ðŸ“¤ Create publish directory on VM
      run: |
        az vm run-command invoke \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.VM_NAME }} \
          --command-id RunShellScript \
          --scripts "sudo mkdir -p /tmp/publish"

    - name: ðŸ“ Copy publish folder to VM
      run: |
        az vm run-command copy \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.VM_NAME }} \
          --source ./publish \
          --destination /tmp/publish

    - name: ðŸ§© Deploy app on VM
      run: |
        az vm run-command invoke \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.VM_NAME }} \
          --command-id RunShellScript \
          --scripts "set -euo pipefail
        TIMESTAMP=\$(date +%Y%m%d%H%M%S)
        RELEASE_DIR=/opt/myapp/releases/\$TIMESTAMP
        sudo mkdir -p \$RELEASE_DIR
        sudo rsync -a /tmp/publish/ \$RELEASE_DIR/
        sudo chown -R myapp:myapp \$RELEASE_DIR
        sudo ln -sfn \$RELEASE_DIR /opt/myapp/current
        sudo chown -h myapp:myapp /opt/myapp/current"

    - name: ðŸ” Inject secrets into VM
      env:
        SERVICEBUS_CONNECTION: ${{ secrets.SERVICEBUS_CONNECTION }}
        PUBLISH_TOPIC: ${{ secrets.PUBLISH_TOPIC }}
        SCHEDULE_TOPIC: ${{ secrets.SCHEDULE_TOPIC }}
      run: |
        az vm run-command invoke \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.VM_NAME }} \
          --command-id RunShellScript \
          --scripts "sudo bash -c 'cat > /etc/myapp.env <<EOF
ASPNETCORE_ENVIRONMENT=Production
SERVICEBUS_CONNECTION=${SERVICEBUS_CONNECTION}
PUBLISH_TOPIC=${PUBLISH_TOPIC}
SCHEDULE_TOPIC=${SCHEDULE_TOPIC}
EOF
chmod 600 /etc/myapp.env
chown root:root /etc/myapp.env'"

    - name: âš™ï¸ Create and start systemd service
      run: |
        az vm run-command invoke \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.VM_NAME }} \
          --command-id RunShellScript \
          --scripts "sudo tee /etc/systemd/system/myapp.service > /dev/null <<'UNIT'
[Unit]
Description=MyApp service
After=network.target

[Service]
User=myapp
WorkingDirectory=/opt/myapp/current
ExecStart=/usr/bin/dotnet /opt/myapp/current/servicebusapi2.dll
Restart=always
RestartSec=5
EnvironmentFile=/etc/myapp.env

[Install]
WantedBy=multi-user.target
UNIT

sudo systemctl daemon-reload
sudo systemctl enable --now myapp.service
sudo systemctl status myapp.service --no-pager -l"
