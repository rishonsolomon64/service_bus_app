name: Publish and Deploy to VM

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Publish app
        run: dotnet publish ./backend/servicebusapi2.csproj -c Release -o ./publish

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      - name: Prepare remote publish folder
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} "sudo mkdir -p /tmp/publish && sudo chown ${{ secrets.VM_USER }}:${{ secrets.VM_USER }} /tmp/publish || true"

      - name: Copy publish to VM
        run: |
          # copy the whole publish directory (not a wildcard) to the remote /tmp/publish
          scp -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key -r ./publish ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}:/tmp/publish

      - name: Deploy on VM (write env, install release, restart)
        env:
          SERVICEBUS_CONNECTION: ${{ secrets.SERVICEBUS_CONNECTION }}
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} bash -s <<EOF
          set -e
          # fail early if publish directory is missing or empty
          if [ ! -d /tmp/publish/publish ] && [ -z "$(ls -A /tmp/publish 2>/dev/null)" ]; then
            echo "ERROR: /tmp/publish is missing or empty" >&2
            exit 2
          fi
          # if scp copied ./publish as a directory, move its contents; otherwise move files
          if [ -d /tmp/publish/publish ]; then
            SRC=/tmp/publish/publish
          else
            SRC=/tmp/publish
          fi
          sudo mkdir -p /opt/myapp/releases/$TIMESTAMP
          sudo mv $SRC/* /opt/myapp/releases/$TIMESTAMP/
          sudo chown -R myapp:myapp /opt/myapp/releases/$TIMESTAMP
          sudo ln -sfn /opt/myapp/releases/$TIMESTAMP /opt/myapp/current
          sudo chown -h myapp:myapp /opt/myapp/current
          printf '%s\n' 'ASPNETCORE_ENVIRONMENT=Production' \
            "SERVICEBUS_CONNECTION=$SERVICEBUS_CONNECTION" \
            "ConnectionStrings__ServiceBus=$SERVICEBUS_CONNECTION" \
          | sudo tee /etc/myapp.env > /dev/null
          sudo chmod 600 /etc/myapp.env
          sudo chown root:root /etc/myapp.env
          echo "FILE_SHA256=$(sudo sha256sum /etc/myapp.env | cut -d' ' -f1)"
          sudo systemctl daemon-reload
          sudo systemctl enable --now myapp.service
          EOF

