name: Deploy .NET App to Azure VM

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
    deploy:
      runs-on: ubuntu-latest
      env:
        SERVICEBUS_CONNECTION: ${{ secrets.SERVICEBUS_CONNECTION }}
        PUBLISH_TOPIC: ${{ secrets.PUBLISH_TOPIC }}
        SCHEDULE_TOPIC: ${{ secrets.SCHEDULE_TOPIC }}
      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Set up .NET 8.0
          uses: actions/setup-dotnet@v4
          with:
            dotnet-version: '8.0.x'

        - name: Restore dependencies
          run: dotnet restore backend/servicebusapi2.csproj

        - name: Build
          run: dotnet build backend/servicebusapi2.csproj --configuration Release --no-restore

        - name: Publish
          run: dotnet publish backend/servicebusapi2.csproj --configuration Release --output ./publish --no-build

        - name: Azure Login
          uses: azure/login@v1
          with:
            creds: ${{ secrets.AZURE_CREDENTIALS }}

        - name: Upload publish.zip to Azure Storage
          run: |
            zip -r publish.zip ./publish
            az storage blob upload \
              --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
              --account-key ${{ secrets.AZURE_STORAGE_KEY }} \
              --container-name deploy-artifacts \
              --name publish.zip \
              --file publish.zip \
              --overwrite
        - name: Generate SAS URL
          id: sas
          run: |
            SAS=$(az storage blob generate-sas \
              --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
              --account-key ${{ secrets.AZURE_STORAGE_KEY }} \
              --container-name deploy-artifacts \
              --name publish.zip \
              --permissions r \
              --expiry $(date -u -d "1 hour" '+%Y-%m-%dT%H:%MZ') \
              --https-only \
              --output tsv)
            echo "url=https://${{ secrets.AZURE_STORAGE_ACCOUNT }}.blob.core.windows.net/deploy-artifacts/publish.zip?$SAS" >> $GITHUB_OUTPUT

        - name: Download and extract app on VM
          run: |
            az vm run-command invoke \
              --resource-group tries \
              --name servicebustry2 \
              --command-id RunShellScript \
              --scripts 'set -e
                wget "${{ steps.sas.outputs.url }}" -O /tmp/publish.zip
                unzip -o /tmp/publish.zip -d /tmp/publish
                rm /tmp/publish.zip'
                
        - name: Organize release on VM
          run: |
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            az vm run-command invoke \
              --resource-group tries \
              --name servicebustry2 \
              --command-id RunShellScript \
              --scripts '
                set -e
                RELEASE_DIR=/opt/myapp/releases/$TIMESTAMP
                sudo mkdir -p \$RELEASE_DIR
                sudo mv /tmp/publish/* \$RELEASE_DIR/
                sudo chown -R myapp:myapp \$RELEASE_DIR
                sudo ln -sfn \$RELEASE_DIR /opt/myapp/current
              '
               
        - name: Inject secrets into /etc/myapp.env
          run: |
            az vm run-command invoke \
              --resource-group tries \
              --name servicebustry2 \
              --command-id RunShellScript \
              --scripts '
                set -e
                printf "SERVICEBUS_CONNECTION=%s\n" "${SERVICEBUS_CONNECTION}" | sudo tee /etc/myapp.env > /dev/null
                printf "PUBLISH_TOPIC=%s\n" "${PUBLISH_TOPIC}" | sudo tee -a /etc/myapp.env > /dev/null
                printf "SCHEDULE_TOPIC=%s\n" "${SCHEDULE_TOPIC}" | sudo tee -a /etc/myapp.env > /dev/null
                sudo chmod 600 /etc/myapp.env
                sudo chown root:root /etc/myapp.env
              '

        - name: Create and start systemd service
          run: |
            az vm run-command invoke \
            --resource-group tries \
            --name servicebustry2 \
            --command-id RunShellScript \
            --scripts '
              set -e
              sudo tee /etc/systemd/system/myapp.service > /dev/null <<EOF
              [Unit]
              Description=MyApp Service
              After=network.target

              [Service]
              EnvironmentFile=/etc/myapp.env
              ExecStart=/usr/bin/dotnet /opt/myapp/current/servicebusapi2.dll
              WorkingDirectory=/opt/myapp/current
              User=myapp
              Restart=always
              RestartSec=10

              [Install]
              WantedBy=multi-user.target
              EOF

              sudo systemctl daemon-reexec
              sudo systemctl daemon-reload
              sudo systemctl enable myapp.service
              sudo systemctl restart myapp.service
            '
                
            

              
